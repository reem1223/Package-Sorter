<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×××©×§ ×”×—×‘×™×œ×•×ª 9.9 - Solid Scroll Pro</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f1f5f9;
            margin: 0; padding: 0;
            user-select: none;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        #root { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

        .app-container {
            background-color: white; width: 100%; max-width: 450px; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative;
        }

        @media (min-height: 700px) { .app-container { height: 850px; max-height: 95vh; border-radius: 2.5rem; } }

        #reader { width: 100% !important; border: none !important; background: #000 !important; height: 280px !important; border-radius: 1.5rem; overflow: hidden; }
        #reader video { height: 280px !important; object-fit: cover !important; }
        
        .recent-card { 
            width: 100%; height: 115px; min-height: 115px; max-height: 115px;
            background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
            overflow: hidden;
        }
        .recent-card:active { transform: scale(0.95); background-color: #f8fafc; }

        .recent-scroll-container { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 115px;
            gap: 12px;
            overflow-y: auto;
            padding: 10px 12px 30px 12px;
            flex: 1;
        }
        .recent-scroll-container::-webkit-scrollbar { width: 4px; }
        .recent-scroll-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .sync-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 6px; }
        .syncing { background-color: #fbbf24; animation: pulse 1s infinite; }
        .synced { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .logo-breathing {
            animation: logo-pulse 3s ease-in-out infinite;
        }
        @keyframes logo-pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.08); }
        }

        .text-flicker {
            animation: flicker 2.5s ease-in-out infinite;
        }
        @keyframes flicker {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .capacity-slider-row {
            background: #f8fafc; border-radius: 1.5rem; padding: 1rem; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem;
        }
        
        .status-overlay {
            position: absolute; inset: 0; background: white; z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }

        .move-shelf-btn {
            background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 8px 4px;
            font-weight: 800; font-size: 14px; transition: all 0.2s;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect, useCallback } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                settings: (
                    <React.Fragment>
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </React.Fragment>
                ),
                camera: (
                    <React.Fragment>
                        <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
                        <circle cx="12" cy="13" r="3" />
                    </React.Fragment>
                ),
                back: <path d="m9 18 6-6-6-6" />,
                smartphone: (
                    <React.Fragment>
                        <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" />
                        <path d="M12 18h.01" />
                    </React.Fragment>
                ),
                monitor: (
                    <React.Fragment>
                        <path d="M2 3h20v10H2z" />
                        <path d="M12 17v4" />
                        <path d="M8 21h8" />
                    </React.Fragment>
                ),
                refresh: <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.85.83 6.72 2.24L21 8M21 3v5h-5" />,
                plus: <path d="M12 5v14M5 12h14" />,
                x: <path d="M18 6 6 18M6 6l12 12" />,
                package: <path d="m7.5 4.27 9 5.15m-9 5.15 9-5.15m-9 5.15V19.5m9-10.15v10.15M3 15.25V8.35L12 3.25L21 8.35V15.25L12 20.35L3 15.25Z" strokeWidth="2" />,
                eye: (
                    <React.Fragment>
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                        <circle cx="12" cy="12" r="3" />
                    </React.Fragment>
                ),
                eyeOff: <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61M2 2l20 20" />,
                move: <path d="m18 8 4 4-4 4M6 16l-4-4 4-4M2 12h20M12 2v20M8 18l4 4 4-4M16 6l-4-4-4 4" />
            };

            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const SHEET_URL = "https://script.google.com/macros/s/AKfycbxTuVPyc62I4xwJojmfWr92z7OLBXM6HSDA4yv6MvPhwnm1II6EsPmt-MV-1BbVXJJA/exec";
        const LOGO_URL = "https://i.imgur.com/OW6rN9h.png";

        function App() {
            const [currentBranch, setCurrentBranch] = useState(null);
            const [view, setView] = useState('branch_select');
            const [deviceMode, setDeviceMode] = useState('1'); 
            const [isManagerVisible, setIsManagerVisible] = useState(true); 
            const [allPackages, setAllPackages] = useState([]);
            const [displayState, setDisplayState] = useState({ id: '---', shelf: '---' });
            const [shelfCapacities, setShelfCapacities] = useState({ A: 5, B: 5, C: 5, D: 5, E: 5, F: 5, G: 5, H: 5 });

            const [searchValue, setSearchValue] = useState(''); 
            const [typingValue, setTypingValue] = useState(''); 
            
            const [isQuickAdd, setIsQuickAdd] = useState(false);
            const [selectedShelfType, setSelectedShelfType] = useState('standard');
            const [searchResults, setSearchResults] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [modalPackage, setModalPackage] = useState(null);
            const [isInitialReady, setIsInitialReady] = useState(false);
            const [scanError, setScanError] = useState(false);

            const shelves = ["A", "B", "C", "D", "E", "F", "G", "H"];
            const pauseSyncUntil = useRef(0);
            const settingsLockUntil = useRef(0);
            const scannerInstance = useRef(null);
            const scrollRef = useRef(null);
            const savedScrollTop = useRef(0);

            useEffect(() => {
                const timer = setTimeout(() => setIsInitialReady(true), 500);
                return () => clearTimeout(timer);
            }, []);

            const handleScroll = useCallback((e) => {
                savedScrollTop.current = e.target.scrollTop;
            }, []);

            const loadData = async (silent = false) => {
                if (!currentBranch || view === 'camera') return;
                if (silent && (Date.now() < pauseSyncUntil.current)) return;
                setIsSyncing(true);
                try {
                    const response = await fetch(`${SHEET_URL}?nocache=${Date.now()}`);
                    const data = await response.json();
                    const newFiltered = data.packages?.filter(p => p.branch === currentBranch) || [];
                    if (JSON.stringify(newFiltered) !== JSON.stringify(allPackages)) setAllPackages(newFiltered);
                    
                    if (data.settings && Date.now() > settingsLockUntil.current) {
                        const newCaps = { A: 5, B: 5, C: 5, D: 5, E: 5, F: 5, G: 5, H: 5 };
                        shelves.forEach(s => {
                            const branchKey = `${currentBranch}_cap_${s}`;
                            if (data.settings[branchKey]) newCaps[s] = parseInt(data.settings[branchKey]);
                        });
                        setShelfCapacities(newCaps);
                    }
                    if (data.displayStates && data.displayStates[currentBranch]) {
                        const dState = data.displayStates[currentBranch];
                        setDisplayState({ id: String(dState.id || '---'), shelf: String(dState.shelf || '---') });
                    }
                    setIsSyncing(false);
                } catch (e) { setIsSyncing(false); }
            };

            useEffect(() => {
                const interval = setInterval(() => loadData(true), 6000);
                return () => clearInterval(interval);
            }, [currentBranch, allPackages, view]);

            useEffect(() => { if (currentBranch) loadData(false); }, [currentBranch]);

            const apiCall = async (params) => {
                setIsSyncing(true);
                pauseSyncUntil.current = Date.now() + 5000;
                try {
                    await fetch(SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ ...params, branch: currentBranch }) });
                    setTimeout(() => loadData(true), 2000);
                } catch (e) { setIsSyncing(false); }
            };

            const handleSelectBranch = (branch) => { setCurrentBranch(branch); setView('home'); };

            const handleUpdateShelfCapacity = (shelf, val) => {
                const newCaps = { ...shelfCapacities, [shelf]: parseInt(val) };
                setShelfCapacities(newCaps);
                settingsLockUntil.current = Date.now() + 8000;
                apiCall({ action: 'updateSettings', key: `${currentBranch}_cap_${shelf}`, value: parseInt(val) });
            };

            const handlePackageAdd = () => {
                const cleanValue = typingValue.replace('-', '');
                if (cleanValue.length !== 6) return;
                let targetShelf = "×—×‘×™×œ×•×ª ×§×˜× ×•×ª";
                if (selectedShelfType === 'standard') {
                    const found = shelves.find(s => allPackages.filter(p => p.shelf === s).length < (shelfCapacities[s] || 5));
                    targetShelf = found || "×—×‘×™×œ×•×ª ×§×˜× ×•×ª";
                }
                const newPkg = { id: String(typingValue), shelf: String(targetShelf), supplier: '×‘×¨ ×”×¤×¦×”' };
                setAllPackages(prev => [newPkg, ...prev]);
                apiCall({ action: 'add', ...newPkg });
                setTypingValue(''); setView('home'); setIsQuickAdd(false);
            };

            const handlePackageDelete = (pkg) => {
                setAllPackages(prev => prev.filter(p => !(p.id === pkg.id && p.shelf === pkg.shelf)));
                apiCall({ action: 'delete', id: pkg.id, shelf: pkg.shelf });
                setModalPackage(null);
                apiCall({ action: 'updateDisplay', id: '---', shelf: '---' });
            };

            const handleMoveShelf = (targetShelf) => {
                if (!modalPackage) return;
                if (targetShelf !== "×—×‘×™×œ×•×ª ×§×˜× ×•×ª" && allPackages.filter(p => p.shelf === targetShelf).length >= (shelfCapacities[targetShelf] || 5)) return;
                const updatedPackage = { ...modalPackage, shelf: targetShelf };
                setAllPackages(prev => prev.map(p => (p.id === modalPackage.id && p.shelf === modalPackage.shelf) ? updatedPackage : p));
                apiCall({ action: 'move', id: modalPackage.id, oldShelf: modalPackage.shelf, newShelf: targetShelf });
                setModalPackage(null);
                apiCall({ action: 'updateDisplay', id: '---', shelf: '---' });
            };

            const triggerDisplay = (pkg) => {
                if (!pkg) return;
                setDisplayState({ id: String(pkg.id), shelf: String(pkg.shelf) });
                apiCall({ action: 'updateDisplay', id: pkg.id, shelf: pkg.shelf });
            };

            const toggleSearch = () => {
                if (searchResults) { setSearchResults(null); setSearchValue(''); }
                else { setSearchResults(allPackages); }
            };

            const closeActionModal = () => {
                setModalPackage(null);
                setDisplayState({ id: '---', shelf: '---' });
                apiCall({ action: 'updateDisplay', id: '---', shelf: '---' });
            };

            useEffect(() => {
                if (view === 'camera' && !scannerInstance.current) {
                    const startScanning = async () => {
                        try {
                            const html5QrCode = new window.Html5Qrcode("reader");
                            scannerInstance.current = html5QrCode;
                            await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 280, height: 120 } }, (decodedText) => {
                                // ×©×™×¤×•×¨: × ×™×§×•×™ ×™×¡×•×“×™ ×©×œ ×¨×•×•×—×™× ×•×ª×•×•×™× × ×¡×ª×¨×™× ×œ×¤× ×™ ×‘×“×™×§×ª ××•×¨×š
                                let clean = decodedText.trim().replace(/[^0-9]/g, '');
                                if (clean.length === 6) {
                                    setTypingValue(clean.slice(0,3) + '-' + clean.slice(3));
                                    setScanError(false); stopScanner(); setView('add'); setIsQuickAdd(true);
                                } else { setScanError(true); setTypingValue(clean); }
                            });
                        } catch (err) { setView('home'); }
                    };
                    setTimeout(startScanning, 250);
                }
                return () => { if (view !== 'camera') stopScanner(); };
            }, [view]);

            const stopScanner = async () => { if (scannerInstance.current) { try { await scannerInstance.current.stop(); scannerInstance.current = null; } catch (e) {} } };

            const FooterCredit = ({ isDisplayView = false }) => (
                <div className={`py-3 text-center shrink-0 ${isDisplayView ? 'absolute bottom-6 w-full opacity-40' : 'bg-slate-50 border-t'}`}>
                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] italic leading-none">NexAria ×¤×ª×¨×•× ×•×ª ×˜×›× ×•×œ×•×’×™×”</p>
                </div>
            );

            const ManagerUI = () => (
                <div className="flex flex-col h-full bg-white relative px-4 text-right overflow-hidden">
                    <div className="py-2 flex justify-between items-center shrink-0 border-b -mx-4 px-4 bg-white z-20">
                        <div className="flex items-center gap-1.5">
                            <button onClick={() => setView('settings')} className="p-2 bg-slate-100 rounded-xl active:scale-90 shadow-sm"><Icon name="settings" size={18} /></button>
                            {deviceMode === '2' && (
                                <button onClick={() => setIsManagerVisible(false)} className="p-2 bg-slate-100 rounded-xl active:scale-90 shadow-sm border border-slate-200"><Icon name="eyeOff" size={18} className="text-slate-500" /></button>
                            )}
                        </div>
                        <div className="bg-slate-50 border border-slate-200 px-4 py-1.5 rounded-2xl flex items-center gap-2 shadow-inner">
                            <span className={`sync-dot ${isSyncing ? 'syncing' : 'synced'}`}></span>
                            <p className="font-black text-[11px] text-slate-800 uppercase leading-none">×××©×§ ×—×‘×™×œ×•×ª</p>
                        </div>
                        <button onClick={() => setCurrentBranch(null)} className="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-md">×¡× ×™×£</button>
                    </div>

                    <div className="py-3 shrink-0 grid grid-cols-2 gap-2 mt-1">
                        <button onClick={() => { setTypingValue(''); setScanError(false); setView('camera'); }} className="col-span-2 bg-blue-600 text-white font-black py-3.5 rounded-2xl shadow-lg active:scale-95 flex items-center justify-center gap-2 leading-none transition-all"><Icon name="camera" size={20} /> ×¡×¨×™×§×” ××”×™×¨×”</button>
                        <button onClick={() => { setTypingValue(''); setIsQuickAdd(true); setView('add'); }} className="bg-emerald-600 text-white font-black py-3 rounded-xl shadow active:scale-95 text-[11px] italic uppercase tracking-tighter">â• ×”×•×¡×¤×”</button>
                        <button onClick={toggleSearch} className={`font-bold py-3 rounded-xl border text-[11px] shadow-sm transition-colors ${searchResults ? 'bg-slate-200 border-slate-400' : 'bg-slate-50 border-slate-200'}`}>âŒ¨ï¸ ×—×™×¤×•×© ×•× ×™×”×•×œ</button>
                    </div>

                    <div className="py-1 flex-1 overflow-hidden flex flex-col text-right">
                        <p className="text-[9px] font-bold text-slate-400 mb-2 tracking-widest font-black italic uppercase">×—×‘×™×œ×•×ª ×¤×¢×™×œ×•×ª:</p>
                        <div className="recent-scroll-container" ref={scrollRef} onScroll={handleScroll}>
                            {allPackages.map((p, idx) => (
                                <div key={`${p.id}-${idx}`} onClick={() => { setModalPackage(p); triggerDisplay(p); }} className="recent-card shadow-sm border-slate-100">
                                    <span className="text-[8px] font-bold text-slate-400 mb-1 leading-none italic">××“×£</span>
                                    <span className={`font-black text-blue-600 leading-tight ${p.shelf === '×—×‘×™×œ×•×ª ×§×˜× ×•×ª' ? 'text-xl' : 'text-4xl'}`}>{String(p.shelf === '×—×‘×™×œ×•×ª ×§×˜× ×•×ª' ? '×§×˜× ×•×ª' : p.shelf)}</span>
                                    <span className="text-[13px] font-black text-slate-800 mt-1.5 italic leading-none">{String(p.id)}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="mt-auto bg-slate-50 border-t p-4 rounded-t-[2.5rem] shrink-0 shadow-inner z-20 text-right">
                        <div className="flex gap-2 mb-3">
                            <div className="flex-1 bg-white border-2 border-slate-200 rounded-xl h-11 flex items-center justify-center font-black text-xl text-slate-800 overflow-hidden">
                                {String(searchValue) || <span className="text-slate-300 text-sm italic">×—×¤×©...</span>}
                            </div>
                            <button onClick={() => setSearchResults(allPackages.filter(p => String(p.id).includes(searchValue)))} className="bg-blue-600 text-white px-6 h-11 rounded-xl font-bold shadow-md text-sm">×—×¤×©</button>
                        </div>
                        {searchResults && (
                            <div className="mb-3 max-h-24 overflow-y-auto space-y-1.5 border-b pb-2">
                                {searchResults.filter(p => String(p.id).includes(searchValue)).map((p, i) => (
                                    <div key={`s-${p.id}-${i}`} className="bg-white p-2.5 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                                        <button onClick={() => { setModalPackage(p); triggerDisplay(p); setSearchResults(null); }} className="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm">× ×™×”×•×œ âš™ï¸</button>
                                        <div className="text-right font-black text-slate-800 text-md italic">{String(p.id)} <span className="text-blue-600">××“×£ {String(p.shelf)}</span></div>
                                    </div>
                                ))}
                            </div>
                        )}
                        <div className="grid grid-cols-3 gap-2">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'â†'].map(key => (
                                <button key={`k-search-${key}`} onClick={() => {
                                    if(key === 'C') setSearchValue('');
                                    else if(key === 'â†') setSearchValue(searchValue.slice(0,-1));
                                    else if(searchValue.length < 10) setSearchValue(searchValue + key);
                                }} className="bg-white border border-slate-200 py-3 rounded-2xl text-xl font-black shadow-sm active:bg-slate-100">{key}</button>
                            ))}
                        </div>
                    </div>
                    <FooterCredit />
                </div>
            );

            if (!isInitialReady) return <div className="status-overlay bg-white">×˜×•×¢×Ÿ...</div>;

            if (view === 'branch_select' || !currentBranch) return (
                <div className="app-container flex flex-col h-full bg-white relative">
                    <div className="flex-1 flex flex-col p-8 items-center justify-center text-center">
                        <img src={LOGO_URL} alt="×œ×•×’×•" className="mb-8 w-48 h-48 object-contain" />
                        <h1 className="text-3xl font-black mb-10 italic">×‘×—×¨ ×¡× ×™×£ ×œ×¢×‘×•×“×”</h1>
                        <div className="w-full space-y-4">
                            <button onClick={() => handleSelectBranch('×¨××ª×™×™×')} className="w-full py-6 bg-blue-600 text-white rounded-[1.8rem] font-black text-xl shadow-lg">ğŸ¡ ×¡× ×™×£ ×¨××ª×™×™×</button>
                            <button onClick={() => handleSelectBranch('×¡×•×§×•×œ×•×‘')} className="w-full py-6 bg-slate-800 text-white rounded-[1.8rem] font-black text-xl shadow-lg">ğŸ¢ ×¡× ×™×£ ×¡×•×§×•×œ×•×‘</button>
                        </div>
                    </div>
                    <FooterCredit />
                </div>
            );

            if (view === 'settings') return (
                <div className="app-container bg-white flex flex-col h-full text-right">
                    <div className="p-6 pb-2 shrink-0 flex justify-between items-center">
                        <h2 className="text-2xl font-black italic">×”×’×“×¨×•×ª {currentBranch}</h2>
                        <button onClick={() => setView('home')} className="p-3 bg-slate-100 rounded-xl"><Icon name="back" className="rotate-180" /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto px-6 space-y-6">
                        <div className="space-y-3">
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mr-1">××¦×‘ ××›×©×™×¨:</p>
                            <button onClick={() => setDeviceMode('1')} className={`w-full flex items-center justify-between p-6 rounded-3xl border-2 transition-all ${deviceMode === '1' ? 'border-blue-600 bg-blue-50 shadow-md' : 'border-slate-100'}`}>
                                <Icon name="smartphone" size={32} className={deviceMode === '1' ? "text-blue-600" : "text-slate-300"} />
                                <div className="text-right">
                                    <p className="font-black text-lg leading-none">×× ×”×œ (××›×©×™×¨ 1)</p>
                                    <p className="text-xs text-slate-400 mt-1 uppercase font-bold tracking-widest text-[9px]">×¡×¨×™×§×” ×•×—×™×¤×•×©</p>
                                </div>
                            </button>
                            <button onClick={() => { setDeviceMode('2'); setIsManagerVisible(true); }} className={`w-full flex items-center justify-between p-6 rounded-3xl border-2 transition-all ${deviceMode === '2' ? 'border-blue-600 bg-blue-50 shadow-md' : 'border-slate-100'}`}>
                                <Icon name="monitor" size={32} className={deviceMode === '2' ? "text-blue-600" : "text-slate-300"} />
                                <div className="text-right">
                                    <p className="font-black text-lg leading-none">×ª×¦×•×’×” (××›×©×™×¨ 2)</p>
                                    <p className="text-xs text-slate-400 mt-1 uppercase font-bold tracking-widest text-[9px]">××¡×š ×¢× ×§ ×¢×‘×•×¨ ×œ×§×•×—×•×ª</p>
                                </div>
                            </button>
                        </div>

                        <div className="space-y-4 text-right">
                            <p className="text-[10px] font-bold text-slate-400 mr-1 uppercase">×§×™×‘×•×œ×ª ××“×¤×™×:</p>
                            {shelves.map(s => (
                                <div key={`cap-${s}`} className="capacity-slider-row shadow-sm">
                                    <div className="flex justify-between items-center"><span className="bg-blue-600 text-white px-3 py-0.5 rounded-full text-xs font-black shadow-sm">××“×£ {s}</span><span className="font-black text-blue-800">{shelfCapacities[s] || 5} ×—×‘×™×œ×•×ª</span></div>
                                    <input type="range" min="1" max="10" value={shelfCapacities[s] || 5} onChange={(e) => handleUpdateShelfCapacity(s, e.target.value)} className="w-full accent-blue-600" />
                                </div>
                            ))}
                        </div>
                    </div>
                    <FooterCredit />
                </div>
            );

            if (view === 'add') {
                const isFormComplete = typingValue.replace('-', '').length === 6;
                return (
                    <div className="app-container bg-white flex flex-col h-full text-right">
                        <div className="p-6 flex-1 flex flex-col">
                            <button onClick={() => { setTypingValue(''); setView('home'); }} className="self-end p-3 bg-slate-100 rounded-xl mb-4 shadow-sm"><Icon name="back" className="rotate-180" /></button>
                            <div className="bg-blue-50 border-2 border-blue-100 rounded-[2.5rem] p-6 text-center mb-4">
                                <p className="text-[10px] font-bold text-blue-400 uppercase italic">××¡×¤×¨ ×—×‘×™×œ×”</p>
                                <p className="text-6xl font-black text-blue-700 tracking-tighter italic leading-none">{String(typingValue) || '----'}</p>
                            </div>
                            <div className="mb-4 text-right">
                                <p className="text-[9px] font-bold text-slate-400 mb-2 mr-2 italic">×‘×—×¨ ×™×¢×“:</p>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => setSelectedShelfType('standard')} className={`py-3.5 rounded-xl font-black ${selectedShelfType === 'standard' ? 'bg-blue-600 text-white shadow-md' : 'bg-white border-2 border-slate-100 text-slate-400'}`}>××“×£ ×¨×’×™×œ</button>
                                    <button onClick={() => setSelectedShelfType('small')} className={`py-3.5 rounded-xl font-black ${selectedShelfType === 'small' ? 'bg-blue-600 text-white shadow-md' : 'bg-white border-2 border-slate-100 text-slate-400'}`}>×—×‘×™×œ×•×ª ×§×˜× ×•×ª</button>
                                </div>
                            </div>
                            <div className="bg-slate-50 border border-slate-200 rounded-[1.8rem] p-3 mb-6">
                                <div className="grid grid-cols-3 gap-2">
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'â†'].map(key => (
                                        <button key={`k-add-${key}`} onClick={() => {
                                            if(key === 'C') setTypingValue('');
                                            else if(key === 'â†') setTypingValue(typingValue.slice(0,-1));
                                            else if(typingValue.length < 7) {
                                                let val = typingValue + key;
                                                if (val.length === 3 && !typingValue.includes('-')) val += '-';
                                                setTypingValue(val);
                                            }
                                        }} className="bg-white border border-slate-200 py-3.5 rounded-2xl text-xl font-black shadow-sm active:bg-slate-100">{key}</button>
                                    ))}
                                </div>
                            </div>
                            <button onClick={handlePackageAdd} disabled={!isFormComplete} className={`mt-auto w-full font-black py-7 rounded-[2.2rem] text-3xl italic shadow-2xl transition-all ${isFormComplete ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-400 opacity-60'}`}>××©×¨ ×•×©××•×¨ âœ…</button>
                        </div>
                        <FooterCredit />
                    </div>
                );
            }

            if (view === 'camera') return (
                <div className="app-container bg-white flex flex-col h-full text-right">
                    <div className="p-6 flex-1 flex flex-col">
                        <button onClick={() => { setTypingValue(''); stopScanner(); setView('home'); }} className="self-end p-3 bg-slate-100 rounded-xl mb-4"><Icon name="x" /></button>
                        <h2 className="text-xl font-black mb-4 italic uppercase leading-none">×¡×¨×™×§×ª ×‘×¨×§×•×“</h2>
                        <div id="reader"></div>
                        <div className={`mt-6 p-6 border-2 rounded-[2rem] text-center italic font-black text-5xl shadow-inner ${scanError ? 'bg-red-50 border-red-200 text-red-600' : 'bg-blue-50 border-blue-100 text-blue-800'}`}>{String(typingValue) || '---'}</div>
                        {scanError && <p className="text-red-600 text-center font-black mt-3 text-sm italic animate-pulse">×©×’×™××”: ×”×‘×¨×§×•×“ ××™× ×• ×‘×Ÿ 6 ×¡×¤×¨×•×ª!</p>}
                    </div>
                    <FooterCredit />
                </div>
            );

            return (
                <div className={`app-container h-full w-full flex overflow-hidden ${deviceMode === '2' ? 'flex-row-reverse max-w-none' : 'flex-col'}`}>
                    {deviceMode === '2' && (
                        <div className="flex-1 bg-slate-900 flex flex-col items-center justify-center text-white border-r-8 border-slate-800 p-12 text-center relative overflow-hidden">
                            {!isManagerVisible && <button onClick={() => setIsManagerVisible(true)} className="absolute top-8 right-8 p-4 bg-white/10 border border-white/20 rounded-2xl"><Icon name="eye" size={24} className="text-blue-400" /></button>}
                            
                            {displayState.id === '---' ? (
                                <div className="flex flex-col items-center">
                                    <div className="w-48 h-48 bg-white/5 rounded-full flex items-center justify-center mb-10 border border-white/10 shadow-2xl backdrop-blur-sm logo-breathing">
                                        <Icon name="package" size={100} className="text-slate-600 opacity-50" />
                                    </div>
                                    <h2 className="text-7xl font-black text-slate-500 italic mb-2 text-flicker">×××ª×™×Ÿ ×œ×—×‘×™×œ×”...</h2>
                                </div>
                            ) : (
                                <div className="w-full flex flex-col items-center">
                                    <p className="text-4xl font-bold text-slate-500 mb-6 italic uppercase leading-none">× × ×œ×’×©×ª ×œ××“×£</p>
                                    <div className="bg-white/5 border-4 border-white/10 p-16 rounded-[4rem] shadow-2xl backdrop-blur-md w-full max-w-4xl">
                                        <h1 className="text-[12rem] font-black leading-none text-blue-500 italic uppercase">{String(displayState.shelf === '×—×‘×™×œ×•×ª ×§×˜× ×•×ª' ? '×§×˜× ×•×ª' : displayState.shelf)}</h1>
                                        <p className="text-[5rem] font-black text-white italic opacity-90 mt-4 leading-none italic">#{String(displayState.id)}</p>
                                    </div>
                                </div>
                            )}
                            <FooterCredit isDisplayView={true} />
                        </div>
                    )}
                    <div className={`${deviceMode === '2' ? (isManagerVisible ? 'w-[450px]' : 'w-0 opacity-0 pointer-events-none') : 'w-full'} h-full border-l border-slate-200 shadow-2xl flex flex-col bg-white overflow-hidden transition-all duration-300`}>
                        <ManagerUI />
                    </div>

                    {modalPackage && (
                        <div className="fixed inset-0 bg-black/80 z-[6000] flex items-center justify-center p-6" onClick={closeActionModal}>
                            <div className="bg-white rounded-[2.5rem] p-8 text-center w-full max-w-sm shadow-2xl animate-in zoom-in duration-200 text-right" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-start mb-6">
                                    <div className="text-right text-right">
                                        <h3 className="text-[10px] font-bold text-slate-400 mb-2 uppercase italic leading-none">× ×™×”×•×œ ×¤×¨×™×˜ ××”×™×¨</h3>
                                        <p className="text-6xl font-black text-slate-900 tracking-tighter leading-none italic uppercase">{String(modalPackage.id)}</p>
                                    </div>
                                    <div className="bg-blue-50 px-4 py-2 rounded-2xl border border-blue-100 text-center">
                                        <p className="text-blue-600 font-black text-2xl italic uppercase">{String(modalPackage.shelf === '×—×‘×™×œ×•×ª ×§×˜× ×•×ª' ? '×§×˜× ×•×ª' : modalPackage.shelf)}</p>
                                    </div>
                                </div>
                                <div className="mb-8 p-4 bg-slate-50 rounded-[1.8rem] border border-slate-100 text-right">
                                    <p className="text-[10px] font-black text-slate-500 mb-4 mr-1 italic">×”×¢×‘×¨×” ×œ××“×£:</p>
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {shelves.map(s => {
                                            const count = allPackages.filter(p => p.shelf === s).length;
                                            const isFull = count >= (shelfCapacities[s] || 5) && modalPackage.shelf !== s;
                                            return (<button key={`mv-${s}`} disabled={isFull} onClick={() => handleMoveShelf(s)} className={`move-shelf-btn ${isFull ? 'opacity-30' : ''} ${modalPackage.shelf === s ? 'border-blue-400 bg-blue-50 text-blue-700 shadow-sm' : ''}`}>{s}<br/><span className="text-[7px]">({count})</span></button>);
                                        })}
                                    </div>
                                    <button onClick={() => handleMoveShelf('×—×‘×™×œ×•×ª ×§×˜× ×•×ª')} className="w-full move-shelf-btn py-3 bg-white flex items-center justify-center gap-2 shadow-sm active:bg-slate-50 italic uppercase">ğŸ“¦ ××“×£ ×§×˜× ×•×ª</button>
                                </div>
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => handlePackageDelete(modalPackage)} className="w-full bg-green-600 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 text-xl italic leading-none uppercase">× ××¡×£ ×‘×”×¦×œ×—×” âœ…</button>
                                    <button onClick={closeActionModal} className="w-full bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl text-sm italic uppercase leading-none">×‘×™×˜×•×œ</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
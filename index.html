<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×××©×§ ×”×—×‘×™×œ×•×ª 9.9 - Solid Scroll Pro</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f1f5f9;
            margin: 0; padding: 0;
            user-select: none;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        #root { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

        .app-container {
            background-color: white; width: 100%; max-width: 450px; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative;
            margin: 0 auto;
        }

        @media (min-height: 700px) { .app-container { height: 850px; max-height: 95vh; border-radius: 2.5rem; } }

        #reader { width: 100% !important; border: none !important; background: #000 !important; height: 280px !important; border-radius: 1.5rem; overflow: hidden; }
        #reader video { height: 280px !important; object-fit: cover !important; }
        
        .recent-card { 
            width: 100%; height: 115px; min-height: 115px; max-height: 115px;
            background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
            overflow: hidden;
        }
        .recent-card:active { transform: scale(0.95); background-color: #f8fafc; }

        .recent-scroll-container { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 115px;
            gap: 12px;
            overflow-y: auto;
            padding: 10px 12px 30px 12px;
            flex: 1;
        }
        .recent-scroll-container::-webkit-scrollbar { width: 4px; }
        .recent-scroll-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .sync-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 6px; }
        .syncing { background-color: #fbbf24; animation: pulse 1s infinite; }
        .synced { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .logo-breathing { animation: logo-pulse 3s ease-in-out infinite; }
        @keyframes logo-pulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.08); } }

        .text-flicker { animation: flicker 2.5s ease-in-out infinite; }
        @keyframes flicker { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }

        .capacity-slider-row {
            background: #f8fafc; border-radius: 1.5rem; padding: 1rem; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem;
        }
        
        .status-overlay { position: absolute; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        .move-shelf-btn { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 8px 4px; font-weight: 800; font-size: 14px; transition: all 0.2s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                settings: (
                    <React.Fragment>
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </React.Fragment>
                ),
                camera: (
                    <React.Fragment>
                        <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
                        <circle cx="12" cy="13" r="3" />
                    </React.Fragment>
                ),
                back: <path d="m9 18 6-6-6-6" />,
                check: <path d="M20 6L9 17l-5-5" strokeWidth="3" />,
                smartphone: (
                    <React.Fragment>
                        <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" />
                        <path d="M12 18h.01" />
                    </React.Fragment>
                ),
                monitor: (
                    <React.Fragment>
                        <path d="M2 3h20v10H2z" />
                        <path d="M12 17v4" />
                        <path d="M8 21h8" />
                    </React.Fragment>
                ),
                package: <path d="m7.5 4.27 9 5.15m-9 5.15 9-5.15m-9 5.15V19.5m9-10.15v10.15M3 15.25V8.35L12 3.25L21 8.35V15.25L12 20.35L3 15.25Z" strokeWidth="2" />,
                eye: (
                    <React.Fragment>
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                        <circle cx="12" cy="12" r="3" />
                    </React.Fragment>
                ),
                eyeOff: <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61M2 2l20 20" />,
                x: <path d="M18 6 6 18M6 6l12 12" />
            };

            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const SHEET_URL = "https://script.google.com/macros/s/AKfycbxTuVPyc62I4xwJojmfWr92z7OLBXM6HSDA4yv6MvPhwnm1II6EsPmt-MV-1BbVXJJA/exec";
        const LOGO_URL = "https://i.imgur.com/OW6rN9h.png";

        function App() {
            const [currentBranch, setCurrentBranch] = useState(null);
            const [view, setView] = useState('branch_select');
            const [deviceMode, setDeviceMode] = useState('1'); 
            const [isManagerVisible, setIsManagerVisible] = useState(true); 
            const [allPackages, setAllPackages] = useState([]);
            const [displayState, setDisplayState] = useState({ id: '---', shelf: '---' });
            const [shelfCapacities, setShelfCapacities] = useState({ A: 5, B: 5, C: 5, D: 5, E: 5, F: 5, G: 5, H: 5 });
            const [searchValue, setSearchValue] = useState(''); 
            const [typingValue, setTypingValue] = useState(''); 
            const [selectedShelfType, setSelectedShelfType] = useState('standard');
            const [manualShelf, setManualShelf] = useState('');
            const [showManualShelfSelect, setShowManualShelfSelect] = useState(false);
            const [searchResults, setSearchResults] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [modalPackage, setModalPackage] = useState(null);
            const [isInitialReady, setIsInitialReady] = useState(false);
            const [scanError, setScanError] = useState(false);
            const [duplicateInfo, setDuplicateInfo] = useState(null);

            const shelves = ["A", "B", "C", "D", "E", "F", "G", "H"];
            const scannerInstance = useRef(null);
            const longPressTimer = useRef(null);

            useEffect(() => { setTimeout(() => setIsInitialReady(true), 500); }, []);

            const loadData = async (silent = false) => {
                if (!currentBranch) return;
                setIsSyncing(true);
                try {
                    const response = await fetch(`${SHEET_URL}?nocache=${Date.now()}`);
                    const data = await response.json();
                    setAllPackages(data.packages?.filter(p => p.branch === currentBranch) || []);
                    if (data.settings) {
                        const newCaps = { ...shelfCapacities };
                        shelves.forEach(s => {
                            const val = data.settings[`${currentBranch}_cap_${s}`];
                            if (val) newCaps[s] = parseInt(val);
                        });
                        setShelfCapacities(newCaps);
                    }
                    if (data.displayStates && data.displayStates[currentBranch]) {
                        setDisplayState({ id: String(data.displayStates[currentBranch].id || '---'), shelf: String(data.displayStates[currentBranch].shelf || '---') });
                    }
                } catch (e) {}
                setIsSyncing(false);
            };

            useEffect(() => {
                if (currentBranch) {
                    loadData(false);
                    const interval = setInterval(() => loadData(true), 3000);
                    return () => clearInterval(interval);
                }
            }, [currentBranch]);

            const apiCall = async (params) => {
                setIsSyncing(true);
                try {
                    await fetch(SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ ...params, branch: currentBranch }) });
                    setTimeout(() => loadData(true), 800);
                } catch (e) { setIsSyncing(false); }
            };

            const startScanner = async () => {
                setView('camera'); setScanError(false); setDuplicateInfo(null); setTypingValue('');
                setTimeout(async () => {
                    try {
                        const scanner = new window.Html5Qrcode("reader");
                        scannerInstance.current = scanner;
                        await scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 280, height: 120 } }, (text) => {
                            let clean = text.trim().replace(/[^0-9-]/g, '').replace('-', '');
                            if (clean.length === 6) {
                                const exists = allPackages.find(p => p.id.replace('-', '') === clean);
                                if (exists) { setScanError(true); setDuplicateInfo(exists.shelf); }
                                else {
                                    setTypingValue(clean.slice(0,3) + '-' + clean.slice(3));
                                    scanner.stop(); setView('add');
                                }
                            } else { setScanError(true); setTypingValue(text); }
                        });
                    } catch (err) { setView('home'); }
                }, 300);
            };

            const handleMoveShelf = (targetShelf) => {
                if (!modalPackage) return;
                apiCall({ action: 'move', id: modalPackage.id, oldShelf: modalPackage.shelf, newShelf: targetShelf });
                setModalPackage(null);
            };

            const ManagerUI = () => (
                <div className="flex flex-col h-full bg-white relative px-4 text-right overflow-hidden">
                    <div className="py-2 flex justify-between items-center shrink-0 border-b -mx-4 px-4 bg-white z-20">
                        <div className="flex items-center gap-1.5">
                            <button onClick={() => setView('settings')} className="p-2 bg-slate-100 rounded-xl active:scale-90 shadow-sm"><Icon name="settings" size={18} /></button>
                            {deviceMode === '2' && (
                                <button onClick={() => setIsManagerVisible(false)} className="p-2 bg-slate-100 rounded-xl active:scale-90 shadow-sm border border-slate-200 text-slate-500"><Icon name="eyeOff" size={18} /></button>
                            )}
                        </div>
                        <div className="bg-slate-50 border border-slate-200 px-4 py-1.5 rounded-2xl flex items-center gap-2 shadow-inner">
                            <span className={`sync-dot ${isSyncing ? 'syncing' : 'synced'}`}></span>
                            <p className="font-black text-[11px] text-slate-800 uppercase leading-none">×××©×§ ×—×‘×™×œ×•×ª</p>
                        </div>
                        <button onClick={() => setCurrentBranch(null)} className="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-md">×¡× ×™×£</button>
                    </div>

                    <div className="py-3 shrink-0 grid grid-cols-2 gap-2 mt-1">
                        <button onClick={startScanner} className="col-span-2 bg-blue-600 text-white font-black py-3.5 rounded-2xl shadow-lg active:scale-95 flex items-center justify-center gap-2 leading-none transition-all"><Icon name="camera" size={20} /> ×¡×¨×™×§×” ××”×™×¨×”</button>
                        <button onClick={() => {setTypingValue(''); setView('add');}} className="bg-emerald-600 text-white font-black py-3 rounded-xl shadow active:scale-95 text-[11px] italic uppercase tracking-tighter">â• ×”×•×¡×¤×”</button>
                        <button onClick={() => setSearchResults(searchResults ? null : allPackages)} className={`font-bold py-3 rounded-xl border text-[11px] shadow-sm transition-colors ${searchResults ? 'bg-slate-200 border-slate-400' : 'bg-slate-50 border-slate-200'}`}>âŒ¨ï¸ ×—×™×¤×•×© ×•× ×™×”×•×œ</button>
                    </div>

                    <div className="flex-1 overflow-y-auto">
                        <div className="recent-scroll-container">
                            {allPackages.map((p, idx) => (
                                <div key={idx} onClick={() => { setModalPackage(p); apiCall({action:'updateDisplay', id:p.id, shelf:p.shelf})}} className="recent-card shadow-sm border-slate-100">
                                    <span className="text-[8px] font-bold text-slate-400 mb-1 leading-none uppercase">××“×£</span>
                                    <span className={`font-black text-blue-600 leading-tight ${p.shelf === '×—×‘×™×œ×•×ª ×§×˜× ×•×ª' ? 'text-xl' : 'text-4xl'}`}>{String(p.shelf === '×—×‘×™×œ×•×ª ×§×˜× ×•×ª' ? '×§×˜× ×•×ª' : p.shelf)}</span>
                                    <span className="text-[13px] font-black text-slate-800 mt-1.5 italic leading-none">#{p.id}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="mt-auto bg-slate-50 border-t p-4 rounded-t-[2.5rem] shrink-0 shadow-inner z-20 text-right">
                        <div className="flex gap-2 mb-3">
                            <div className="flex-1 bg-white border-2 border-slate-200 rounded-xl h-11 flex items-center justify-center font-black text-xl text-slate-800 overflow-hidden text-center">{searchValue || '×—×¤×©...'}</div>
                            <button onClick={() => setSearchResults(allPackages.filter(p => String(p.id).includes(searchValue)))} className="bg-blue-600 text-white px-6 h-11 rounded-xl font-bold shadow-md text-sm">×—×¤×©</button>
                        </div>
                        {searchResults && (
                            <div className="mb-3 max-h-24 overflow-y-auto space-y-1.5 border-b pb-2 text-right">
                                {searchResults.filter(p => String(p.id).includes(searchValue)).map((p, i) => (
                                    <div key={i} className="bg-white p-2.5 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                                        <button onClick={() => { setModalPackage(p); setSearchResults(null); }} className="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm">× ×™×”×•×œ âš™ï¸</button>
                                        <div className="text-right font-black text-slate-800 text-md italic">{String(p.id)} <span className="text-blue-600">××“×£ {p.shelf}</span></div>
                                    </div>
                                ))}
                            </div>
                        )}
                        <div className="grid grid-cols-3 gap-2">
                            {['1','2','3','4','5','6','7','8','9','C','0','â†'].map(key => (
                                <button key={`ks-${key}`} onClick={() => {
                                    if(key === 'C') setSearchValue('');
                                    else if(key === 'â†') setSearchValue(searchValue.slice(0,-1));
                                    else if(searchValue.length < 10) setSearchValue(searchValue + key);
                                }} className="bg-white border border-slate-200 py-3.5 rounded-2xl text-xl font-black shadow-sm active:bg-slate-100 transition-all">{key}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (!isInitialReady) return <div className="status-overlay bg-white">×˜×•×¢×Ÿ...</div>;

            if (view === 'branch_select' || !currentBranch) return (
                <div className="app-container p-8 items-center justify-center text-center flex flex-col">
                    <img src={LOGO_URL} alt="×œ×•×’×•" className="mb-8 w-48 h-48 mx-auto" />
                    <h1 className="text-3xl font-black mb-10 italic leading-none">×‘×—×¨ ×¡× ×™×£ ×œ×¢×‘×•×“×”</h1>
                    <button onClick={() => {setCurrentBranch('×¨××ª×™×™×'); setView('home');}} className="w-full py-6 mb-4 bg-blue-600 text-white rounded-[1.8rem] font-black text-xl shadow-lg transition-all active:scale-95">ğŸ¡ ×¡× ×™×£ ×¨××ª×™×™×</button>
                    <button onClick={() => {setCurrentBranch('×¡×•×§×•×œ×•×‘'); setView('home');}} className="w-full py-6 bg-slate-800 text-white rounded-[1.8rem] font-black text-xl shadow-lg transition-all active:scale-95">ğŸ¢ ×¡× ×™×£ ×¡×•×§×•×œ×•×‘</button>
                </div>
            );

            if (view === 'add') {
                const pureNum = typingValue.replace('-', '');
                const isFormComplete = pureNum.length === 6;
                const isDuplicate = allPackages.some(p => p.id.replace('-', '') === pureNum);
                return (
                    <div className="app-container p-6 text-right">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={() => { if(isFormComplete && !isDuplicate) { apiCall({action:'add', id:typingValue, shelf: selectedShelfType === 'small' ? "×—×‘×™×œ×•×ª ×§×˜× ×•×ª" : (manualShelf || shelves.find(s => allPackages.filter(p => p.shelf === s).length < (shelfCapacities[s] || 5)) || "×—×‘×™×œ×•×ª ×§×˜× ×•×ª")}); setTypingValue(''); setView('home'); } }} disabled={!isFormComplete || isDuplicate} className={`p-3 rounded-xl transition-all ${isFormComplete && !isDuplicate ? 'bg-emerald-500 text-white shadow-lg' : 'bg-slate-100 text-slate-300'}`}><Icon name="check" size={24} /></button>
                            <button onClick={() => {setTypingValue(''); setManualShelf(''); setView('home');}} className="p-3 bg-slate-100 rounded-xl active:scale-90 transition-all"><Icon name="back" className="rotate-180" /></button>
                        </div>
                        <div className={`border-2 rounded-[2.5rem] p-6 text-center mb-4 ${isDuplicate ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-100'}`}>
                            <p className="text-6xl font-black tracking-tighter italic leading-none">{String(typingValue) || '----'}</p>
                            {isDuplicate && <p className="text-red-600 text-sm font-black mt-3 animate-pulse">×©×’×™××”: ×›×‘×¨ ×§×™×™× ×‘××“×£ {allPackages.find(p => p.id.replace('-', '') === pureNum)?.shelf}</p>}
                        </div>
                        <div className="mb-4 grid grid-cols-2 gap-2">
                            <div className="relative">
                                <button onMouseDown={() => longPressTimer.current = setTimeout(()=>setShowManualShelfSelect(true), 600)} onMouseUp={()=>clearTimeout(longPressTimer.current)} onTouchStart={() => longPressTimer.current = setTimeout(()=>setShowManualShelfSelect(true), 600)} onTouchEnd={()=>clearTimeout(longPressTimer.current)} onClick={() => {if(!showManualShelfSelect){setSelectedShelfType('standard'); setManualShelf('');}}} className={`w-full py-3.5 rounded-xl font-black transition-all ${selectedShelfType === 'standard' ? 'bg-blue-600 text-white shadow-md' : 'bg-white border-2 border-slate-100 text-slate-400'}`}>{manualShelf ? `××“×£ ${manualShelf}` : '××“×£ ×¨×’×™×œ'}</button>
                                {showManualShelfSelect && (
                                    <div className="absolute top-0 left-0 w-full z-50 bg-white border-2 border-blue-600 rounded-xl p-2 grid grid-cols-4 gap-1 shadow-2xl animate-in zoom-in duration-200">
                                        {shelves.map(s => (<button key={s} onClick={() => {setManualShelf(s); setShowManualShelfSelect(false);}} className="aspect-square bg-slate-50 border rounded font-bold text-blue-600 shadow-sm">{s}</button>))}
                                        <button onClick={()=>setShowManualShelfSelect(false)} className="col-span-4 py-1 text-[10px] text-slate-400 text-center uppercase italic">×‘×™×˜×•×œ X</button>
                                    </div>
                                )}
                            </div>
                            <button onClick={() => setSelectedShelfType('small')} className={`py-3.5 rounded-xl font-black transition-all ${selectedShelfType === 'small' ? 'bg-blue-600 text-white shadow-md' : 'bg-white border-2 border-slate-100 text-slate-400'}`}>×§×˜× ×•×ª</button>
                        </div>
                        <div className="bg-slate-50 rounded-[1.8rem] p-4 grid grid-cols-3 gap-2 border">
                            {['1','2','3','4','5','6','7','8','9','C','0','â†'].map(k => (
                                <button key={`ka-${k}`} onClick={() => {
                                    if(k==='C') setTypingValue('');
                                    else if(k==='â†') setTypingValue(typingValue.slice(0,-1));
                                    else if(pureNum.length < 6) {
                                        let v = typingValue + k;
                                        if (v.length === 3 && !v.includes('-')) v += '-';
                                        setTypingValue(v);
                                    }
                                }} className="bg-white py-4 rounded-2xl shadow-sm font-black text-xl active:bg-blue-50 transition-all">{k}</button>
                            ))}
                        </div>
                        <button onClick={() => { if(isFormComplete && !isDuplicate) { apiCall({action:'add', id:typingValue, shelf: selectedShelfType === 'small' ? "×—×‘×™×œ×•×ª ×§×˜× ×•×ª" : (manualShelf || shelves.find(s => allPackages.filter(p => p.shelf === s).length < (shelfCapacities[s] || 5)) || "×—×‘×™×œ×•×ª ×§×˜× ×•×ª")}); setTypingValue(''); setView('home'); } }} disabled={!isFormComplete || isDuplicate} className={`mt-auto w-full font-black py-7 rounded-[2.2rem] text-3xl shadow-xl transition-all ${isFormComplete && !isDuplicate ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-400'}`}>××©×¨ ×•×©××•×¨ âœ…</button>
                    </div>
                );
            }

            if (view === 'camera') return (
                <div className="app-container p-6 text-right">
                    <button onClick={() => {if(scannerInstance.current) scannerInstance.current.stop(); setView('home');}} className="self-end p-3 bg-slate-100 rounded-xl mb-4 shadow-sm active:scale-90"><Icon name="x" /></button>
                    <h2 className="text-xl font-black mb-4 uppercase text-right leading-none italic">×¡×¨×™×§×ª ×‘×¨×§×•×“</h2>
                    <div id="reader"></div>
                    <div className={`mt-6 p-6 border-2 rounded-[2rem] text-center font-black text-5xl shadow-inner ${scanError ? 'bg-red-50 border-red-200 text-red-600' : 'bg-blue-50 border-blue-100 text-blue-800'}`}>{typingValue || '---'}</div>
                    {scanError && <p className="text-red-600 text-center font-black mt-3 animate-pulse italic">{duplicateInfo ? `×›×‘×¨ × ×¡×¨×§! × ××¦× ×‘××“×£ ${duplicateInfo}` : '×©×’×™××”: ×§×•×“ ×œ× ×ª×§×™×Ÿ!'}</p>}
                </div>
            );

            if (view === 'settings') return (
                <div className="app-container bg-white flex flex-col h-full text-right overflow-hidden">
                    <div className="p-6 shrink-0 flex justify-between items-center border-b">
                        <h2 className="text-2xl font-black italic">×”×’×“×¨×•×ª</h2>
                        <button onClick={() => setView('home')} className="p-3 bg-slate-100 rounded-xl active:scale-90 shadow-sm"><Icon name="back" className="rotate-180" /></button>
                    </div>
                    {/* ×›××Ÿ ×”×•×¡×¤×ª×™ ××ª ×”-overflow-y-auto ×©×××¤×©×¨ ×’×œ×™×œ×” */}
                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                        <div className="space-y-4">
                            <button onClick={() => {setDeviceMode('1'); setView('home');}} className={`w-full p-6 rounded-3xl border-2 transition-all ${deviceMode === '1' ? 'border-blue-600 bg-blue-50 shadow-md' : 'border-slate-100'}`}><p className="font-black text-lg text-right">×× ×”×œ (1)</p></button>
                            <button onClick={() => {setDeviceMode('2'); setView('home');}} className={`w-full p-6 rounded-3xl border-2 transition-all ${deviceMode === '2' ? 'border-blue-600 bg-blue-50 shadow-md' : 'border-slate-100'}`}><p className="font-black text-lg text-right">×ª×¦×•×’×” (2)</p></button>
                        </div>
                        <div className="mt-6 border-t pt-6">
                            <p className="text-xs font-bold text-slate-400 mb-4 uppercase italic tracking-widest">×§×™×‘×•×œ×ª ××“×¤×™×:</p>
                            {shelves.map(s => (
                                <div key={`cap-${s}`} className="capacity-slider-row shadow-sm">
                                    <div className="flex justify-between items-center text-right"><span className="bg-blue-600 text-white px-3 py-0.5 rounded-full text-xs font-black shadow-sm">××“×£ {s}</span><span className="font-black text-blue-800">{shelfCapacities[s] || 5}</span></div>
                                    <input 
                                        type="range" min="1" max="10" 
                                        value={shelfCapacities[s] || 5} 
                                        onChange={(e) => setShelfCapacities(prev => ({...prev, [s]: parseInt(e.target.value)}))}
                                        onMouseUp={(e) => apiCall({action:'updateSettings', key:`${currentBranch}_cap_${s}`, value:parseInt(e.target.value)})}
                                        onTouchEnd={(e) => apiCall({action:'updateSettings', key:`${currentBranch}_cap_${s}`, value:parseInt(e.target.value)})}
                                        className="w-full accent-blue-600" 
                                    />
                                </div>
                            ))}
                        </div>
                        <button onClick={() => setCurrentBranch(null)} className="w-full p-6 bg-slate-900 text-white rounded-3xl font-bold shadow-md active:scale-95 transition-all text-lg mt-4">×”×—×œ×£ ×¡× ×™×£</button>
                        <div className="h-10"></div> {/* ×¨×•×•×— ×§×˜×Ÿ ×‘×¡×•×£ ×”×’×œ×™×œ×” */}
                    </div>
                </div>
            );

            return (
                <div className="w-full h-full flex overflow-hidden flex-row">
                    <div className={`${deviceMode === '2' ? (isManagerVisible ? 'w-[450px]' : 'w-0 overflow-hidden') : 'w-full'} h-full transition-all duration-300 flex items-center justify-center rtl border-l border-slate-200`}>
                        <div className="app-container shadow-2xl">
                            <ManagerUI />
                        </div>
                    </div>

                    {deviceMode === '2' && (
                        <div className="flex-1 bg-slate-900 flex flex-col items-center justify-center text-white p-12 text-center relative overflow-hidden h-full ltr">
                            {!isManagerVisible && (
                                <button onClick={() => setIsManagerVisible(true)} className="absolute top-8 right-8 p-4 bg-white/10 border border-white/20 rounded-2xl shadow-xl backdrop-blur-md z-50 active:scale-90 transition-all text-blue-400">
                                    <Icon name="eye" size={24} />
                                </button>
                            )}
                            {displayState.id === '---' ? (
                                <div className="flex flex-col items-center">
                                    <div className="w-48 h-48 bg-white/5 rounded-full flex items-center justify-center mb-10 border border-white/10 logo-breathing shadow-2xl backdrop-blur-sm"><Icon name="eye" size={100} className="text-slate-600 opacity-50" /></div>
                                    <h2 className="text-7xl font-black text-slate-500 italic text-flicker uppercase">×××ª×™×Ÿ ×œ×—×‘×™×œ×”...</h2>
                                </div>
                            ) : (
                                <div className="w-full flex flex-col items-center animate-in zoom-in duration-300">
                                    <p className="text-4xl font-bold text-slate-500 mb-6 uppercase italic">× × ×œ×’×©×ª ×œ××“×£</p>
                                    <div className="bg-white/5 border-4 border-white/10 p-16 rounded-[4rem] shadow-2xl backdrop-blur-md w-full max-w-4xl">
                                        <h1 className="text-[12rem] font-black leading-none text-blue-500 uppercase italic leading-none">{String(displayState.shelf === '×—×‘×™×œ×•×ª ×§×˜× ×•×ª' ? '×§×˜× ×•×ª' : displayState.shelf)}</h1>
                                        <p className="text-[5rem] font-black text-white italic opacity-90 mt-4 leading-none">#{displayState.id}</p>
                                    </div>
                                </div>
                            )}
                            <div className="absolute bottom-6 w-full text-center opacity-40 text-slate-400 italic text-xs font-bold uppercase tracking-widest">NexAria ×¤×ª×¨×•× ×•×ª ×˜×›× ×•×œ×•×’×™×”</div>
                        </div>
                    )}

                    {modalPackage && (
                        <div className="fixed inset-0 bg-black/80 z-[6000] flex items-center justify-center p-6 text-right" onClick={() => setModalPackage(null)}>
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm text-center shadow-2xl animate-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                                <h3 className="text-6xl font-black mb-6 italic tracking-tighter leading-none italic uppercase">#{modalPackage.id}</h3>
                                <div className="mb-8 p-4 bg-slate-50 rounded-3xl text-right font-black italic">
                                    <p className="text-[10px] text-slate-500 mb-4 uppercase italic leading-none">×”×¢×‘×¨×” ×œ××“×£:</p>
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {shelves.map(s => {
                                            const count = allPackages.filter(p => p.shelf === s).length;
                                            const cap = shelfCapacities[s] || 5;
                                            const isFull = count >= cap && modalPackage.shelf !== s;
                                            return (<button key={`md-${s}`} disabled={isFull} onClick={() => handleMoveShelf(s)} className={`move-shelf-btn ${isFull ? 'bg-red-100 border-red-200 text-red-600 opacity-80' : modalPackage.shelf === s ? 'border-blue-400 bg-blue-50 text-blue-700 shadow-sm' : ''}`}>{s}<br/><span className={`text-[7px] ${isFull ? 'text-red-500' : ''}`}>({count}/{cap})</span></button>);
                                        })}
                                    </div>
                                    <button onClick={() => handleMoveShelf('×—×‘×™×œ×•×ª ×§×˜× ×•×ª')} className="w-full move-shelf-btn py-3 bg-white border-2 rounded-2xl font-black text-blue-600 active:bg-slate-50 transition-all uppercase italic">ğŸ“¦ ×”×¢×‘×¨×” ×œ×§×˜× ×•×ª</button>
                                </div>
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => {apiCall({action:'delete', id:modalPackage.id, shelf:modalPackage.shelf}); apiCall({action:'updateDisplay', id:'---', shelf:'---'}); setModalPackage(null);}} className="w-full bg-emerald-600 text-white py-5 rounded-2xl text-xl shadow-lg font-black uppercase italic transition-all active:scale-95">× ××¡×£ ×‘×”×¦×œ×—×” âœ…</button>
                                    <button onClick={() => {setDisplayState({id:'---', shelf:'---'}); apiCall({action:'updateDisplay', id:'---', shelf:'---'}); setModalPackage(null);}} className="mt-4 w-full bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl text-sm italic uppercase leading-none shadow-sm transition-all active:scale-95">×‘×™×˜×•×œ ×•××™×¤×•×¡ ×ª×¦×•×’×”</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
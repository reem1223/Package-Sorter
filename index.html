<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>砖拽 转 5.5 - 爪 专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f1f5f9;
            margin: 0; padding: 0;
            user-select: none;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        #app {
            background-color: white;
            width: 100%;
            max-width: 450px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
        }

        @media (min-height: 700px) {
            #app { height: 850px; max-height: 95vh; border-radius: 2.5rem; }
        }

        /* 注爪 驻转专 专 驻注 */
        .active-option {
            background-color: #2563eb !important; 
            color: white !important;
            border-color: #1e40af !important; 
            transform: translateY(-4px) !important;
            box-shadow: 0 12px 20px -5px rgba(37, 99, 235, 0.4) !important;
        }

        /* 专住转 转 专转 */
        .recent-card { 
            width: 110px; height: 125px; flex-shrink: 0;
            background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 20px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .recent-card:active { transform: scale(0.92); }

        /* 拽转 专转 */
        .keypad-btn { 
            background-color: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; 
            border-radius: 20px; height: 52px; font-size: 1.4rem; font-weight: 800;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.1s;
        }
        .keypad-btn:active { background-color: #f1f5f9; transform: scale(0.95); }

        /* 住 注 */
        #status-screen {
            position: absolute; inset: 0; background: #ffffff; z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }

        .progress-container {
            width: 80%; max-width: 280px; height: 8px;
            background-color: #f1f5f9; border-radius: 99px;
            overflow: hidden; margin-bottom: 1rem;
        }

        .progress-bar-fill {
            height: 100%; width: 0%;
            background-color: #32CD32;
            box-shadow: 0 0 10px rgba(50, 205, 50, 0.5);
            border-radius: 99px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sync-dot {
            width: 8px; height: 8px; border-radius: 50%;
            display: inline-block; margin-left: 6px;
        }
        .syncing { background-color: #fbbf24; animation: pulse 1s infinite; }
        .synced { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /*  */
        #modal-overlay, #control-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); z-index: 6000;
            align-items: center; justify-content: center;
        }
        .modal-bg { background-color: #ffffff; border-radius: 2.5rem; padding: 1.5rem; width: 90%; max-width: 360px; text-align: center; }

        .recent-scroll-container { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 8px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .recent-scroll-container::-webkit-scrollbar { display: none; }

        .supplier-badge { font-size: 8px; font-weight: 800; padding: 2px 8px; border-radius: 99px; text-transform: uppercase; margin-top: 6px; }
        .badge-epost { background: #fee2e2; color: #dc2626; }
        .badge-distribution { background: #dcfce7; color: #166534; }
        .badge-hfd { background: #dbeafe; color: #2563eb; }

        .branch-btn {
            width: 100%; padding: 2rem 1rem; border-radius: 1.5rem; border: 2px solid #e2e8f0;
            background: white; text-align: center; transition: all 0.3s;
        }
        .branch-btn:active { transform: scale(0.95); border-color: #2563eb; }
    </style>
</head>
<body>

    <div id="app">
        <!-- 住 注 -->
        <div id="status-screen">
            <div class="flex flex-col items-center w-full">
                <h1 class="text-2xl font-black text-slate-800 mb-8 tracking-tight italic">砖拽 转 5.5</h1>
                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar-fill"></div>
                </div>
                <p id="status-text-display" class="text-xs font-bold text-slate-400 uppercase tracking-widest"> 专 爪...</p>
            </div>
        </div>

        <div id="main-content" class="flex flex-col h-full overflow-hidden"></div>
    </div>

    <!--  驻注转 -->
    <div id="modal-overlay" onclick="window.closeActionModal()">
        <div class="modal-bg" onclick="event.stopPropagation()">
            <h3 class="text-xs font-bold text-gray-400 mb-1 uppercase tracking-widest leading-none"> </h3>
            <p id="m-loc-text" class="font-extrabold text-xs mb-1 uppercase"></p>
            <p id="m-id-text" class="text-6xl font-black text-gray-900 mb-8 tracking-tighter leading-none"></p>
            <div class="flex flex-col gap-3">
                <button id="m-collect-btn" class="w-full bg-green-600 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 text-xl">住祝 (拽)</button>
                <button onclick="window.closeActionModal()" class="w-full bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl active:scale-95">专</button>
            </div>
        </div>
    </div>

    <!--  住驻专转 拽专转 (专 驻爪) -->
    <div id="control-modal-overlay">
        <div class="modal-bg">
            <h3 class="text-lg font-black text-slate-800 mb-2">住驻专转 拽专转 专砖转</h3>
            <p class="text-xs text-slate-500 mb-4 leading-relaxed text-center">爪 驻转 专 驻爪.<br>拽砖 3 住驻专转 拽专转:</p>
            
            <div class="bg-slate-100 rounded-2xl py-4 mb-4 border border-blue-200">
                <p id="control-id-display" class="text-[10px] text-slate-400 font-bold mb-1"></p>
                <p id="control-input-display" class="text-4xl font-black text-blue-600 tracking-[0.2em]">---</p>
            </div>

            <!-- 拽转 转  -->
            <div class="grid grid-cols-3 gap-1.5 mb-5" id="modal-keypad-container"></div>

            <div class="flex flex-col gap-2">
                <button onclick="window.confirmControlDigits()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 text-lg transition-all">砖专 砖专</button>
                <button onclick="window.closeControlModal()" class="w-full bg-slate-100 text-slate-500 font-bold py-2.5 rounded-xl active:scale-95 text-sm"></button>
            </div>
        </div>
    </div>

    <script>
        window.SHEET_URL = "https://script.google.com/macros/s/AKfycbxTuVPyc62I4xwJojmfWr92z7OLBXM6HSDA4yv6MvPhwnm1II6EsPmt-MV-1BbVXJJA/exec";
        
        window.state = {
            allPackages: [],
            currentBranch: null, 
            currentView: 'branch_select', 
            typingValue: '',
            searchResults: null,
            selectedOption: null,
            isSyncing: false,
            isEnteringControlDigits: false,
            controlDigits: '',
            originalIdForControl: '',
            
            //   注 注 驻
            pauseSyncUntil: 0
        };

        const MAX_PER_SHELF = 15;
        const suppliers = ["Epost", "专 驻爪", "HFD"]; 
        const SHELF_GROUPS = {
            "Epost": ["A", "B"],
            "专 驻爪": ["C", "D"],
            "HFD": ["E", "F"],
            "Overflow": ["G", "H"]
        };
        const shelves = ["A", "B", "C", "D", "E", "F", "G", "H"];

        // --- 驻拽爪转 住专 注 ---

        async function loadData(silent = false) {
            // :  专注 爪注 转, 注 专注 -3 砖转  注 
            if (silent && Date.now() < window.state.pauseSyncUntil) return;

            const bar = document.getElementById('progress-bar');
            const txt = document.getElementById('status-text-display');
            if(!silent) { if(bar) bar.style.width = '30%'; if(txt) txt.innerText = "转专..."; }
            
            window.state.isSyncing = true;
            if(window.state.currentView === 'home') window.render();

            try {
                const response = await fetch(`${window.SHEET_URL}?nocache=${Date.now()}`, { method: 'GET', redirect: 'follow' });
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    window.state.allPackages = data.map(p => ({
                        id: (p.id || p.ID || '').toString().trim(),
                        shelf: (p.shelf || p.SHELF || '').toString().trim(),
                        supplier: (p.supplier || p.SUPPLIER || '').toString().trim(),
                        branch: (p.branch || p.BRANCH || '专转').toString().trim()
                    }));
                }
                
                window.state.isSyncing = false;
                if (!silent) {
                    if(bar) bar.style.width = '100%';
                    setTimeout(() => {
                        const loader = document.getElementById('status-screen');
                        if (loader) loader.style.display = 'none';
                        window.render();
                    }, 600);
                } else {
                    window.render();
                }
            } catch (e) {
                window.state.isSyncing = false;
                window.render();
            }
        }

        // 专注   10 砖转
        setInterval(() => loadData(true), 10000);

        async function syncUpdateOptimistic(action, pkgData) {
            window.state.isSyncing = true;
            // 砖转 专注  -3 砖转  注 
            window.state.pauseSyncUntil = Date.now() + 3000;

            const fullPkg = { ...pkgData, branch: window.state.currentBranch, timestamp: Date.now() };
            
            // --- 注 驻  ---
            if (action === 'add') {
                window.state.allPackages.push(fullPkg);
            } else if (action === 'delete') {
                window.state.allPackages = window.state.allPackages.filter(p => 
                    !(p.id === pkgData.id && p.shelf === pkgData.shelf && p.branch === window.state.currentBranch)
                );
            }
            
            window.render();

            try {
                // 砖 专拽注  转 住转 -UI
                fetch(window.SHEET_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ action, ...fullPkg }) 
                }).then(() => {
                    // 专 转, 转 注 注 转 注
                    setTimeout(() => loadData(true), 2500);
                });
            } catch (e) { 
                window.state.isSyncing = false; 
                window.render(); 
            }
        }

        // --- 拽转 专专 ---

        window.render = function() {
            const container = document.getElementById('main-content');
            if (!container) return;
            const scrollContainer = container.querySelector('.recent-scroll-container');
            const savedScrollPos = scrollContainer ? scrollContainer.scrollLeft : 0;

            if (window.state.currentView === 'branch_select') renderBranchSelect(container);
            else if (window.state.currentView === 'home') renderHome(container);
            else renderAdd(container);

            const newScroll = container.querySelector('.recent-scroll-container');
            if (newScroll) newScroll.scrollLeft = savedScrollPos;
            
            if (window.state.isEnteringControlDigits) renderModalKeypad();
        }

        function renderBranchSelect(container) {
            container.innerHTML = `
                <div class="flex flex-col h-full p-8 items-center justify-center bg-white text-center">
                    <h2 class="text-3xl font-black mb-10 italic text-slate-800 leading-tight tracking-tighter">砖拽 转<br>专 住祝</h2>
                    <div class="w-full space-y-4">
                        <button onclick="window.selectBranch('专转')" class="branch-btn shadow-lg active:scale-95 transition-all">
                            <span class="text-3xl block mb-2"></span><span class="text-xl font-black text-slate-800">住祝 专转</span>
                        </button>
                        <button onclick="window.selectBranch('住拽')" class="branch-btn shadow-lg active:scale-95 transition-all">
                            <span class="text-3xl block mb-2"></span><span class="text-xl font-black text-slate-800">住祝 住拽</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHome(container) {
            const data = window.state.allPackages.filter(p => p.branch === window.state.currentBranch);
            const recent = [...data].reverse().slice(0, 15);
            
            container.innerHTML = `
                <div class="flex flex-col h-full overflow-hidden">
                    <div class="p-4 flex justify-between items-center shrink-0">
                        <div class="w-10"></div>
                        <div class="bg-slate-50 border border-slate-200 px-6 py-2 rounded-[2rem] text-center shadow-sm flex items-center justify-center gap-2.5">
                            <span class="sync-dot ${window.state.isSyncing ? 'syncing' : 'synced'}"></span>
                            <div>
                                <p class="text-[9px] font-bold text-slate-500 uppercase leading-none tracking-tighter">${window.state.currentBranch}</p>
                                <p class="text-[12px] mt-0.5 text-slate-800 font-extrabold uppercase leading-none">砖拽 转</p>
                            </div>
                        </div>
                        <button onclick="window.state.currentBranch = null; window.state.currentView = 'branch_select'; window.render();" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-[11px] font-bold active:scale-95">住祝</button>
                    </div>

                    <div class="px-5 pb-4 shrink-0">
                        <button onclick="window.setView('add')" class="w-full bg-blue-600 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-blue-100 text-xl active:scale-95 italic transition-all">
                             住驻转  ${window.state.currentBranch}
                        </button>
                    </div>

                    <div class="px-5 py-3 overflow-hidden text-right">
                        <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase text-xs tracking-widest">转 专转 住祝:</p>
                        <div class="recent-scroll-container">
                            ${recent.length > 0 ? recent.map(p => {
                                let bCls = p.supplier === 'Epost' ? 'badge-epost' : p.supplier === '专 驻爪' ? 'badge-distribution' : 'badge-hfd';
                                return `<div onclick="window.openActionModal('${p.id}', '${p.shelf}', '${p.supplier}')" class="recent-card shadow-md animate-in fade-in duration-300">
                                    <span class="text-[9px] font-bold text-slate-400 leading-none mb-1 uppercase tracking-widest">祝 ${p.shelf}</span>
                                    <span class="text-4xl font-black text-blue-600 leading-none">${p.shelf}</span>
                                    <span class="text-[13px] font-black text-slate-800 mt-1">${p.id}</span>
                                    <span class="supplier-badge ${bCls}">${p.supplier}</span>
                                </div>`;
                            }).join('') : '<div class="w-full py-8 text-center text-slate-300 italic border border-dashed rounded-xl"> 转 住祝</div>'}
                        </div>
                    </div>

                    <div class="mt-auto bg-slate-50 border-t border-slate-200 p-5 rounded-t-[2.5rem] shadow-inner text-right">
                        <div id="results-area" class="empty:hidden mb-3 max-h-32 overflow-y-auto space-y-2">
                            ${window.state.searchResults ? (window.state.searchResults.length === 0 ? '<p class="text-center text-red-500 font-bold text-xs py-2 animate-pulse">  爪</p>' : window.state.searchResults.map(p => {
                                let bCls = p.supplier === 'Epost' ? 'badge-epost' : p.supplier === '专 驻爪' ? 'badge-distribution' : 'badge-hfd';
                                return `<div class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-2xl shadow-sm">
                                    <div class="text-right">
                                        <p class="font-black text-lg text-slate-800 leading-none italic">${p.id} <span class="text-blue-600 font-black">祝 ${p.shelf}</span></p>
                                        <span class="supplier-badge ${bCls} inline-block">${p.supplier}</span>
                                    </div>
                                    <button onclick="window.deletePackage('${p.id}', '${p.shelf}')" class="bg-green-600 text-white px-5 py-2 rounded-xl text-xs font-bold active:scale-95 shadow-md">住祝</button>
                                </div>`;
                            }).join('')) : ''}
                        </div>
                        <div class="flex gap-2 mb-4">
                            <div class="flex-1 bg-white border-2 border-slate-200 rounded-2xl h-14 flex items-center justify-center shadow-inner">
                                <span class="${window.state.typingValue ? 'text-3xl font-black text-slate-800' : 'text-slate-300 text-sm italic'}">${window.state.typingValue || '驻砖 住驻专 ...'}</span>
                            </div>
                            <button onclick="window.handleSearch()" class="bg-blue-600 text-white px-8 h-14 rounded-2xl font-bold active:scale-95 shadow-md transition-all">驻砖</button>
                        </div>
                        ${renderKeypadHtml()}
                    </div>
                </div>
            `;
        }

        function renderAdd(container) {
            container.innerHTML = `
                <div class="flex flex-col h-full p-6 bg-white">
                    <button onclick="window.setView('home')" class="self-start p-3 bg-slate-100 rounded-xl mb-4 text-xl shadow-sm active:scale-95"></button>
                    <div class="bg-blue-50 border-2 border-blue-100 rounded-[2rem] p-4 text-center mb-6 shadow-sm">
                        <p class="text-[10px] font-bold text-blue-400 uppercase mb-1 leading-none tracking-widest text-center">住驻专 </p>
                        <p class="text-6xl font-black text-blue-700 min-h-[60px] tracking-tighter leading-none text-center">${window.state.typingValue || '----'}</p>
                    </div>
                    <div class="mb-4 text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-3 mr-1 tracking-widest">专 住驻拽 (祝 专 ):</p>
                        <div class="grid grid-cols-3 gap-2">
                            ${suppliers.map(s => `<button onclick="window.setOption('${s}')" class="option-btn border-2 py-4 rounded-2xl text-[13px] font-bold ${window.state.selectedOption === s ? 'active-option' : 'bg-white border-slate-100 text-slate-600'}">${s}</button>`).join('')}
                        </div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 rounded-3xl p-4 mb-4 shadow-inner text-right">
                        ${renderKeypadHtml()}
                    </div>
                    <button onclick="window.savePackage()" class="mt-auto w-full bg-blue-600 text-white font-black py-5 rounded-2xl text-xl shadow-xl active:scale-95 italic transition-all">砖专 砖专 </button>
                </div>
            `;
        }

        function renderKeypadHtml() {
            return `
                <div class="grid grid-cols-3 gap-2">
                    ${[1,2,3,4,5,6,7,8,9].map(n => `<button onclick="window.typeKey('${n}')" class="keypad-btn shadow-sm">${n}</button>`).join('')}
                    <button onclick="window.clearKey()" class="keypad-btn bg-slate-100 text-xs font-bold shadow-sm">C</button>
                    <button onclick="window.typeKey('0')" class="keypad-btn shadow-sm">0</button>
                    <button onclick="window.backKey()" class="keypad-btn bg-slate-100 text-xl font-bold shadow-sm"></button>
                </div>
            `;
        }

        function renderModalKeypad() {
            const container = document.getElementById('modal-keypad-container');
            if(!container) return;
            container.innerHTML = `
                ${[1,2,3,4,5,6,7,8,9].map(n => `<button onclick="window.typeKey('${n}')" class="keypad-btn shadow-sm h-12 text-lg">${n}</button>`).join('')}
                <button onclick="window.clearKey()" class="keypad-btn bg-slate-100 text-xs font-bold h-12">C</button>
                <button onclick="window.typeKey('0')" class="keypad-btn shadow-sm h-12 text-lg">0</button>
                <button onclick="window.backKey()" class="keypad-btn bg-slate-100 text-xl h-12 font-bold"></button>
            `;
        }

        // --- Logic Handlers ---

        window.selectBranch = (b) => { window.state.currentBranch = b.trim(); window.state.currentView = 'home'; const loader = document.getElementById('status-screen'); if (loader) loader.style.display = 'none'; window.render(); loadData(); };
        window.setView = (v) => { window.state.currentView = v; window.state.typingValue = ''; window.state.searchResults = null; window.state.selectedOption = null; window.state.isEnteringControlDigits = false; window.render(); };
        window.setOption = (opt) => { window.state.selectedOption = opt; window.render(); };
        
        window.typeKey = (k) => { 
            if (window.state.isEnteringControlDigits) {
                if (window.state.controlDigits.length < 3) {
                    window.state.controlDigits += k;
                    const display = document.getElementById('control-input-display');
                    if (display) display.innerText = window.state.controlDigits.padEnd(3, '-');
                }
                return;
            }
            if(window.state.typingValue.length < 4) { 
                window.state.typingValue += k; 
                if(window.state.currentView === 'home') window.state.searchResults = null; 
                window.render(); 
            } 
        };
        
        window.clearKey = () => { 
            if (window.state.isEnteringControlDigits) { 
                window.state.controlDigits = ''; 
                const display = document.getElementById('control-input-display');
                if (display) display.innerText = '---'; 
                return; 
            }
            window.state.typingValue = ''; if(window.state.currentView==='home') window.state.searchResults=null; window.render(); 
        };

        window.backKey = () => { 
            if (window.state.isEnteringControlDigits) { 
                window.state.controlDigits = window.state.controlDigits.slice(0, -1); 
                const display = document.getElementById('control-input-display');
                if (display) display.innerText = window.state.controlDigits.padEnd(3, '-').replace(/ /g, '-'); 
                return; 
            }
            window.state.typingValue = window.state.typingValue.slice(0, -1); window.render(); 
        };

        // 驻拽爪转 拽爪转 祝  (15 转 祝)
        function findSmartShelf(supplier) {
            const dedicated = SHELF_GROUPS[supplier];
            const overflow = ["G", "H"];
            const currentBranchPackages = window.state.allPackages.filter(p => p.branch === window.state.currentBranch);
            
            const getCount = (shelfName) => currentBranchPackages.filter(p => p.shelf === shelfName).length;

            for (let shelf of dedicated) { if (getCount(shelf) < MAX_PER_SHELF) return shelf; }
            for (let shelf of overflow) { if (getCount(shelf) < MAX_PER_SHELF) return shelf; }
            return null;
        }

        window.savePackage = () => {
            if (window.state.typingValue.length < 2 || !window.state.selectedOption) return;
            const id = window.state.typingValue;
            const loc = window.state.selectedOption;
            
            const isDuplicate = window.state.allPackages.some(p => 
                (p.id === id || p.id.startsWith(id + "-")) && 
                p.branch === window.state.currentBranch
            );

            if (loc === '专 驻爪' && id.length === 3 && isDuplicate) {
                window.openControlDigitModal(id);
                return;
            }

            const targetShelf = findSmartShelf(loc);
            if (!targetShelf) { showToast(" 拽 驻 驻!", "error"); return; }

            syncUpdateOptimistic('add', { id: id, shelf: targetShelf, supplier: loc });
            window.setView('home');
        };

        window.openControlDigitModal = (id) => {
            window.state.isEnteringControlDigits = true;
            window.state.controlDigits = '';
            window.state.originalIdForControl = id;
            const displayId = document.getElementById('control-id-display');
            if (displayId) displayId.innerText = `注专  ${id}`;
            const displayInput = document.getElementById('control-input-display');
            if (displayInput) displayInput.innerText = '---';
            const modal = document.getElementById('control-modal-overlay');
            if (modal) modal.style.display = 'flex';
            renderModalKeypad();
        };

        window.confirmControlDigits = () => {
            if (window.state.controlDigits.length !== 3) return;
            const finalId = `${window.state.originalIdForControl}-${window.state.controlDigits}`;
            const targetShelf = findSmartShelf('专 驻爪');
            if (!targetShelf) { showToast("住 专 驻爪 !", "error"); return; }
            syncUpdateOptimistic('add', { id: finalId, shelf: targetShelf, supplier: '专 驻爪' });
            window.closeControlModal();
            window.setView('home');
        };

        window.closeControlModal = () => { window.state.isEnteringControlDigits = false; const modal = document.getElementById('control-modal-overlay'); if (modal) modal.style.display = 'none'; };

        window.handleSearch = () => {
            if (!window.state.typingValue) return;
            const term = window.state.typingValue;
            window.state.searchResults = window.state.allPackages.filter(p => 
                p.id.includes(term) && p.branch === window.state.currentBranch
            );
            window.render();
        };

        window.deletePackage = (id, shelf) => { 
            syncUpdateOptimistic('delete', { id, shelf }); 
            if (window.state.searchResults) {
                window.state.searchResults = window.state.searchResults.filter(p => !(p.id === id && p.shelf === shelf));
                if (window.state.searchResults.length === 0) window.state.searchResults = null;
            }
            window.closeActionModal(); 
        };

        window.openActionModal = (id, shelf, supplier) => { 
            const mid = document.getElementById('m-id-text');
            const mloc = document.getElementById('m-loc-text');
            const mo = document.getElementById('modal-overlay');
            if(mid) mid.innerText = id; 
            if(mloc) mloc.innerText = `住祝: ${window.state.currentBranch} | 祝 ${shelf} | 转 ${supplier}`; 
            if(mo) mo.style.display = 'flex'; 
            const btn = document.getElementById('m-collect-btn');
            if(btn) btn.onclick = () => window.deletePackage(id, shelf); 
        };
        window.closeActionModal = () => { const mo = document.getElementById('modal-overlay'); if (mo) mo.style.display = 'none'; };

        function showToast(text, type = 'success') {
            const t = document.createElement('div');
            const bg = type === 'success' ? 'bg-slate-800' : 'bg-red-600';
            t.className = `fixed top-10 left-1/2 -translate-x-1/2 ${bg} text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[8000] text-sm transform transition-all duration-300 opacity-100`;
            t.innerText = text;
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, -20px)'; setTimeout(() => t.remove(), 300); }, 2500);
        }

        // 注 专砖转
        loadData();
    </script>
</body>
</html>